# Архитектура KataCut (высокоуровнево, без примеров кода)

Область: контекст системы, контейнеры, роли компонентов, потоки `sync` (dry‑run/apply), модель плана/таргетов, адаптеры, ошибки/восстановление, телеметрия, тестирование, безопасность, дорожная карта. Визуализация — ASCII/ANSI‑схемы.

## 1) Цель и не‑цели
- Цель: дать стабильную ментальную модель развития `@katacut/cli` без привязки к деталям реализации.
- Не‑цели: без примеров кода, без фиксации публичных API, без гайдов под конкретных вендоров.

## 2) Принципы
- Hexagonal (Порты/Адаптеры): домен отделён от I/O.
- Детерминированный и идемпотентный `sync`; по умолчанию — dry‑run.
- Схема как источник истины; строгая валидация; не используем `null` (только `undefined`).
- Минимально необходимые привилегии; явные побочные эффекты; наблюдаемость «из коробки».

## 3) Системный контекст

```
  +--------+        +-----------+        +---------+
  | Польз. | -----> |    CLI    | -----> |  Core   |
  +--------+        +-----------+        +---------+
                         |   |
                         |   v
                         | +-----------+
                         | |  Schema   |
                         | +-----------+
                         v
                    +-----------------+
                    |    Adapters     |
                    +-----------------+
                         |       \
                         v        v
                    +--------+  +-------------+
                    |  FS    |  |   Clients   |
                    +--------+  +-------------+
                                     |
                                     v
                            +------------------+
                            |   OS / Tools     |
                            +------------------+

  Внешнее:
    CLI - - - > MCP Registry
    CLI - - - > Secrets Provider
```

Пояснения: CLI оркеструет; Schema валидирует; Core строит план; Adapters применяют к клиентам (файлы/CLI); внешние реестры/секреты подключаются явно.

## 4) Контейнеры (монорепо)

```
packages/
  schema   (@katacut/schema)  [JSON Schema + AJV]
  core     (@katacut/core)    [Plan & Diff]
  cli      (@katacut/cli)     [Команды]
  utils    (@katacut/utils)   [FS/Ошибки/Логи]
  adapters (@katacut/adapters/*)
    ├─ client-cursor
    ├─ client-vscode
    ├─ client-visual-studio
    └─ client-claude

Связи:
  CLI  -> SCHEMA, CORE, UTILS
  CORE -> ADAPTERS
  ADAPTERS -> UTILS
```

## 5) Ответственности компонентов
- Schema: парсит/валидирует JSONC; возвращает типизированный конфиг или структурированные ошибки.
- Core: чистые функции — строит `SyncPlan` (summary, targets, diff), без I/O.
- Adapters: применяют таргеты к конкретным клиентам (файлы/CLI), транзакционные записи.
- CLI: оркестровка сценариев, флаги (`--dry-run`, `--apply`, `--config`), стабильный вывод.
- Utils: утилиты FS/ошибок/логирования без состояния.

## 6) Поток sync (dry‑run)

```
1) Пользователь: katacut sync --dry-run
2) CLI: читает и валидирует конфиг через Schema
3) Core: строит план (summary, targets, diff)
4) CLI: печатает план (JSON + человеко‑читаемое summary)
```

## 7) Поток sync (apply)

```
1) Пользователь: katacut sync --apply
2) CLI: валидирует конфиг (Schema)
3) Core: строит план и диффы
4) По каждому таргету:
   4.1) CLI вызывает адаптер
   4.2) Адаптер пишет во временный файл → атомарно переименовывает
   4.3) Адаптер возвращает результат: created/updated/skip
5) CLI: итоговый отчёт по таргетам
```

## 8) Модель плана и таргетов (концепция)

```
+-------------------+
|     SyncPlan      |
|-------------------|
| summary: string   |
| targets: Target[] |
+-------------------+
          |
          v
+-------------------------------+
|          Target               |
|-------------------------------|
| name: string                  |
| client: cursor|vscode|claude|vs|
| destination: path|command     |
| contentHash: string           |
| diff: { kind, preview }       |
| actions: [create|update|skip] |
+-------------------------------+
```

## 9) Порты и адаптеры

```
Core --(targets)--> ApplyPort --> [Adapter: Cursor] --> .cursor/mcp.json
                                 \-> [Adapter: VS Code] -> .vscode/mcp.json
```

Обязанности адаптера: выбор области (project/user), стабильный JSON (порядок ключей, перевод строки в конце), транзакционные записи (temp + rename), точный отчёт.

## 10) Ошибки и восстановление
- Классы: ValidationError, AdapterError, IO‑отчёт, UnexpectedError.
- Политика:
  - Валидационные ошибки → немедленный отказ (non‑zero), печать всех issues.
  - Ошибки применения → агрегируем по таргетам; общий статус «ошибка», если критический таргет не применён.
  - Всегда поддерживаем `--dry-run` для предварительного осмотра.
- Идемпотентность: совпадающее содержимое → `skip` (diff.kind = none).

## 11) Телеметрия и наблюдаемость (концепция)
- Трассы: `sync.parse`, `sync.validate`, `sync.plan`, `sync.diff`, `adapter.apply`.
- Метрики: длительность операций, число записей, created/updated/skipped.
- Логи: структурированные строки по таргету (client, action, result).

## 12) Тестирование
- Unit (Schema/Core): чистые функции; «золотые» фикстуры планов/диффов.
- Contract (Adapters): снапшоты ожидаемых файлов/команд из таргетов.
- CLI: снапшоты stdout для `--dry-run`/`--apply` (моки адаптеров).
- E2E (smoke): чистый проект → `init → sync --dry-run → sync --apply`.

## 13) Безопасность и приватность
- По умолчанию секреты не сохраняем; подключаем только по явной настройке.
- Пишем только известные пути; глобальные записи — по явному выбору пользователя.
- Без сетевых вызовов без флага/указания; временные файлы — в безопасных директориях.

## 14) Дорожная карта (фазы)
1. Ужесточить схему MCP (http|stdio; обязательные поля).
2. Core: реальные таргеты (сначала Cursor) + краткий diff.
3. Adapter Cursor: детерминированная запись JSON, идемпотентность.
4. CLI `sync --apply`: связать с адаптерами; стабильный вывод/коды выхода.
5. Adapter VS Code (project scope): расширить покрытие клиентов.
6. Doctor (детект клиентов/путей) + базовые хуки телеметрии.

## 15) Глоссарий
- Таргет: конкретная инструкция материализовать конфигурацию для клиента.
- Дифф: краткое описание отличий между желаемым и текущим состоянием.
- Apply: выполнение побочных эффектов для достижения желаемого состояния.
