# KataCut — статус проекта (продуктовый обзор)

Обновлено: 18 октября 2025 года

## Идея и ценность
KataCut — «единая точка правды» для инструментов разработчика с ИИ. Команда хранит нужные инструменты (MCP‑серверы) в одном конфигурационном файле репозитория и одним действием приводит рабочую среду в требуемое состояние на любой машине.

Зачем это нужно:
- Быстрый онбординг: «клонировал репозиторий → применил конфиг → работаешь».
- Единообразие в команде: у всех одинаковый набор инструментов и настроек.
- Предсказуемость: повторное применение ничего лишнего не меняет (идемпотентность).
- Прозрачность: всегда видно, что подключено в проекте и у пользователя.

## Что уже готово (MVP для Claude Code)
- Единый конфиг проекта: `katacut.config.jsonc` — перечень требуемых MCP‑инструментов (HTTP/STDIO).
- Просмотр текущего состояния:
  - `kc mcp list --client claude-code` — сводка по проектным и пользовательским настройкам.
  - `--scope project` — показывает содержимое файла проекта.
  - `--scope user` — показывает пользовательские настройки.
- Приведение системы к конфигу:
  - `kc install --client claude-code` — применяет конфигурацию.
  - `--scope project` — обновляет проектный файл; изменения можно коммитить.
  - `--scope user` — обновляет пользовательские настройки.
  - `--dry-run` — сначала показывает план действий (add/update/remove/skip).
  - `--prune` — удаляет лишнее, не описанное в конфиге.
- Идемпотентность: повторный `kc install` без изменений даёт только `skip`.

## Пользовательские сценарии
- Новый разработчик: клонирует проект и одной командой получает готовую среду в Claude Code.
- Командное выравнивание: у всей команды одинаковый набор MCP‑инструментов за счёт проектного файла в репозитории.
- Чистка «дрейфа» настроек: `--prune` убирает лишние записи.
- Безопасное применение: `--dry-run` показывает, что именно будет сделано, перед тем как вносить изменения.

## Новое (диагностика и lockfile/CI)
- Диагностика окружения:
  - `kc doctor --client claude-code` — JSON‑отчёт о доступности CLI, правах на project/user файлы, конфликтах и общем статусе (`ok|warn|error`).
  - Показывает `capabilities` клиента (какие scope поддерживаются) и краткую табличную сводку «Doctor Summary» с рекомендациями.
  - Учитывает локальный state (см. ниже): при его отсутствии выдаёт предупреждение (warn) с подсказкой прогнать `install`.
- Lockfile и проверка в CI:
  - Lockfile проекта: `katacut.lock.json` фиксирует желаемое состояние по конфигу (для выбранного scope).
  - `kc lock generate` — сформировать lockfile из конфига (без применения).
  - `kc lock verify` — сверить lockfile с фактическим состоянием; ненулевой код при расхождении (под CI).
  - `kc ci` — обёртка над `lock verify` с JSON‑отчётом и ненулевым кодом при mismatch (удобно для пайплайнов).
- Поведение `kc install` (аналог npm/pnpm):
  - По умолчанию после успешного применения обновляет `katacut.lock.json`.
  - `--no-write-lock` — не трогать lock при применении.
  - `--frozen-lock` — «замороженный» режим: требует существующий lock и точное соответствие конфигу; при расхождении — ошибка, без изменений.
  - `--lockfile-only` — обновить/создать lockfile и выйти, не применяя изменения.
  - По умолчанию scope=`project`. Для `--prune` требуется подтверждение `-y/--yes`.

## Локальный state (факт применения)
- Путь: `./.katacut/state.json` (локально, не коммитится — добавлен в `.gitignore`).
- Содержит сведения о последнем успешном `install`: `requestedScope`, `realizedScope`, `mode (native|emulated)`, сводку результатов и fingerprints по каждой записи.
- Используется `kc doctor` для сопоставления Desired (lock) ↔ Current (файлы) ↔ Realized (state) и формирования рекомендаций.

## Ограничения сейчас
- Поддерживается один клиент — `claude-code`.

## Ближайшие шаги
- Улучшенный отчёт `install/doctor`: компактная таблица изменений и рекомендации.
- Capabilities/эмуляция scope: маркировка `native|emulated`, политика fallback при отсутствии `project` у клиента.
- Глобальные операции (по аналогии с `-g`): явные команды/флаг, учёт в пользовательском состоянии, интеграция с `doctor`.
- Документация и примеры конфигов для типовых сценариев.
- Research: enterprise overrides и кроссплатформенный резолвер путей (см. `.tasks/2025-10-18-enterprise-overrides-research.md`).

## Кроссплатформенные пути (актуализировано)
- Project: `./.mcp.json`.
- User (порядок поиска):
  - POSIX: `~/.claude/settings.json`, `~/.claude.json`, `$XDG_CONFIG_HOME/claude/settings.json`, затем `$XDG_CONFIG_HOME/claude/config.json`.
  - Windows (fallback): `%USERPROFILE%/.claude/settings.json`, `%USERPROFILE%/.claude.json`, при наличии — `%APPDATA%/Claude/settings.json`.
- Enterprise (перекрытие, планируется детекция в `doctor`):
  - macOS: `/Library/Application Support/ClaudeCode/managed-settings.json`, `/Library/Application Support/ClaudeCode/managed-mcp.json`.
  - Linux/WSL: `/etc/claude-code/managed-settings.json`, `/etc/claude-code/managed-mcp.json`.
  - Windows: `C:\\ProgramData\\ClaudeCode\\managed-settings.json`, `C:\\ProgramData\\ClaudeCode\\managed-mcp.json`.

## Критерии успеха
- Онбординг в новый проект занимает минуты, а не часы/дни.
- Одинаковая среда у всей команды без ручных инструкций.
- Минимум расхождений между конфигом и фактическим состоянием на машинах разработчиков.

## Демо за 2 минуты
1) Показать `katacut.config.jsonc` — что требуется проекту.
2) Выполнить `kc mcp list --client claude-code` — «как сейчас».
3) Выполнить `kc install --client claude-code --dry-run` — план действий.
4) Выполнить `kc install --client claude-code` — применить.
5) Повторить `kc install --client claude-code --dry-run` — только `skip`.
